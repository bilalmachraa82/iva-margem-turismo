<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVA Margem Turismo - Cálculo Simplificado</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Poppins + Work Sans (Accounting Advantage Fonts) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Work Sans', sans-serif;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* Hover Effects */
        .hover-lift {
            transition: all 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        /* Loading Spinner */
        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Association indicator */
        .has-associations {
            position: relative;
        }
        
        .has-associations::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #10B981;
        }

        /* 2025 Ultra Modern Design - Advantage.pt Corporate Identity */

        /* Advantage Brand System */
        :root {
            --advantage-navy: #0b0c1e;
            --advantage-blue: #1e3a8a;
            --advantage-light: #f8fafc;
            --advantage-gray: #64748b;
            --advantage-accent: #3b82f6;
            --advantage-success: #10b981;
            --advantage-warning: #f59e0b;
            --advantage-danger: #ef4444;
            --advantage-border: #e2e8f0;
        }

        /* Modern Corporate Cards */
        .modern-card {
            background: white;
            border: 1px solid var(--advantage-border);
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .modern-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--advantage-accent), var(--advantage-success));
            border-radius: 12px 12px 0 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modern-card:hover {
            border-color: var(--advantage-accent);
            box-shadow: 0 4px 12px 0 rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .modern-card:hover::before {
            opacity: 1;
        }

        /* Corporate Navy Sections */
        .navy-header {
            background: linear-gradient(135deg, var(--advantage-navy) 0%, var(--advantage-blue) 100%);
            color: white;
        }

        .navy-accent {
            background: var(--advantage-navy);
            color: white;
        }

        /* Professional Typography */
        .heading-corporate {
            font-family: 'Work Sans', sans-serif;
            font-weight: 600;
            color: var(--advantage-navy);
            letter-spacing: -0.025em;
        }

        .text-corporate {
            font-family: 'Poppins', sans-serif;
            color: var(--advantage-gray);
            line-height: 1.6;
        }

        /* Chart Container Corporate */
        .chart-container {
            background: white;
            border: 1px solid var(--advantage-border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
        }

        .chart-container:hover {
            border-color: var(--advantage-accent);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        /* Data Visualization Professional */
        .data-point {
            background: white;
            border: 1px solid var(--advantage-border);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s ease;
            position: relative;
        }

        .data-point:hover {
            border-color: var(--advantage-accent);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        /* Interactive Elements Corporate */
        .interactive-element {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .interactive-element:hover {
            transform: translateY(-1px);
        }

        .interactive-element:active {
            transform: scale(0.98);
        }

        /* Button System Modern */
        .btn-primary-corporate {
            background: var(--advantage-navy);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-family: 'Work Sans', sans-serif;
            font-weight: 500;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary-corporate:hover {
            background: var(--advantage-blue);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(11, 12, 30, 0.25);
        }

        .btn-secondary-corporate {
            background: white;
            border: 1px solid var(--advantage-navy);
            border-radius: 8px;
            padding: 12px 24px;
            font-family: 'Work Sans', sans-serif;
            font-weight: 500;
            color: var(--advantage-navy);
            transition: all 0.3s ease;
        }

        .btn-secondary-corporate:hover {
            background: var(--advantage-navy);
            color: white;
            transform: translateY(-1px);
        }

        /* Status Indicators Professional */
        .status-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #065f46;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #92400e;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #991b1b;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Progress Indicators Modern */
        .progress-modern {
            background: #f1f5f9;
            border-radius: 6px;
            overflow: hidden;
            height: 8px;
        }

        .progress-modern .progress-bar {
            background: linear-gradient(90deg, var(--advantage-accent), var(--advantage-success));
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s ease;
        }

        /* Corporate Gradient Text */
        .gradient-corporate {
            background: linear-gradient(135deg, var(--advantage-navy) 0%, var(--advantage-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Subtle Micro-interactions */
        .micro-feedback {
            animation: subtle-scale 0.2s ease;
        }

        @keyframes subtle-scale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Loading States */
        .loading-corporate {
            background: linear-gradient(90deg, #f8fafc 25%, #e2e8f0 50%, #f8fafc 75%);
            background-size: 200% 100%;
            animation: shimmer-corporate 1.5s infinite;
        }

        @keyframes shimmer-corporate {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50" x-data="ivaApp()">
    <!-- Corporate Header -->
    <header class="navy-header shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-xl bg-white bg-opacity-20 flex items-center justify-center mr-4">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white heading-corporate">IVA Margem Turismo</h1>
                        <p class="text-sm text-blue-100">Regime Especial CIVA Art. 308º — Solução Profissional</p>
                    </div>
                    <div class="hidden lg:block ml-10 pl-10 border-l border-blue-300 border-opacity-50">
                        <p class="text-xs text-blue-200 uppercase tracking-wider font-medium">Powered by</p>
                        <p class="text-lg font-bold text-white">Accounting Advantage</p>
                    </div>
                </div>
                
                <!-- Corporate Progress Indicator -->
                <div class="hidden md:flex items-center space-x-6">
                    <div class="flex items-center">
                        <div class="flex items-center" :class="currentStep >= 1 ? 'text-white' : 'text-blue-300'">
                            <span class="w-10 h-10 rounded-full border-2 flex items-center justify-center text-sm font-semibold transition-all"
                                  :class="currentStep >= 1 ? 'border-white bg-white text-navy-800' : 'border-blue-300'">
                                1
                            </span>
                            <span class="ml-3 text-sm font-medium">Upload</span>
                        </div>

                        <div class="w-12 h-1 mx-4 rounded-full transition-all" :class="currentStep >= 2 ? 'bg-white' : 'bg-blue-300 bg-opacity-50'"></div>

                        <div class="flex items-center" :class="currentStep >= 2 ? 'text-white' : 'text-blue-300'">
                            <span class="w-10 h-10 rounded-full border-2 flex items-center justify-center text-sm font-semibold transition-all"
                                  :class="currentStep >= 2 ? 'border-white bg-white text-navy-800' : 'border-blue-300'">
                                2
                            </span>
                            <span class="ml-3 text-sm font-medium">Associar</span>
                        </div>

                        <div class="w-12 h-1 mx-4 rounded-full transition-all" :class="currentStep >= 3 ? 'bg-white' : 'bg-blue-300 bg-opacity-50'"></div>

                        <div class="flex items-center" :class="currentStep >= 3 ? 'text-white' : 'text-blue-300'">
                            <span class="w-10 h-10 rounded-full border-2 flex items-center justify-center text-sm font-semibold transition-all"
                                  :class="currentStep >= 3 ? 'border-white bg-white text-navy-800' : 'border-blue-300'">
                                3
                            </span>
                            <span class="ml-3 text-sm font-medium">Resultado</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Reset Button -->
        <div x-show="currentStep > 1" class="flex justify-end mb-6">
            <button @click="resetSession()"
                    class="btn-secondary-corporate interactive-element flex items-center">
                <i class="fas fa-refresh mr-2"></i>
                <span>Nova Sessão</span>
            </button>
        </div>

        <!-- Step 1: Upload -->
        <div x-show="currentStep === 1" class="animate-slide-up" id="etapa1">
            <div class="modern-card p-8">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold heading-corporate mb-3">Iniciar Cálculo IVA</h2>
                    <p class="text-corporate mb-8 text-lg">Importe ficheiros SAF-T ou e-Fatura, ou utilize dados de demonstração para teste</p>
                    
                    <!-- Upload Type Tabs Corporate -->
                    <div class="mb-8">
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button @click="uploadType = 'saft'"
                                    class="flex-1 px-6 py-3 text-sm font-semibold rounded-md transition-all interactive-element"
                                    :class="uploadType === 'saft' ? 'bg-white text-navy-800 shadow-sm' : 'text-gray-600 hover:text-gray-800'">
                                <i class="fas fa-file-code mr-2"></i>
                                SAF-T (XML)
                            </button>
                            <button @click="uploadType = 'efatura'"
                                    class="flex-1 px-6 py-3 text-sm font-semibold rounded-md transition-all interactive-element"
                                    :class="uploadType === 'efatura' ? 'bg-white text-navy-800 shadow-sm' : 'text-gray-600 hover:text-gray-800'">
                                <i class="fas fa-file-csv mr-2"></i>
                                e-Fatura (CSV)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Upload Area for SAF-T Corporate -->
                    <div x-show="uploadType === 'saft'" class="border-2 border-dashed rounded-xl p-12 text-center transition-all"
                         :class="dragOver ? 'border-blue-400 bg-blue-50' : 'border-gray-300 hover:border-blue-400'"
                         @dragover.prevent="dragOver = true"
                         @dragleave.prevent="dragOver = false"
                         @drop.prevent="handleDrop($event)">

                        <div class="w-16 h-16 mx-auto mb-6 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-cloud-upload-alt text-2xl"
                               :class="dragOver ? 'text-blue-600' : 'text-blue-500'"></i>
                        </div>

                        <h3 class="text-xl font-semibold heading-corporate mb-2">
                            Carregar Ficheiro SAF-T
                        </h3>
                        <p class="text-corporate mb-6">Arraste o ficheiro XML aqui ou clique para selecionar</p>

                        <input type="file" id="fileInput" class="hidden" accept=".xml" @change="handleFileSelect">

                        <button onclick="document.getElementById('fileInput').click()"
                                class="btn-primary-corporate interactive-element">
                            <i class="fas fa-folder-open mr-2"></i>
                            Selecionar Ficheiro
                        </button>

                        <p class="text-sm text-gray-500 mt-6">
                            <i class="fas fa-check-circle text-green-500 mr-1"></i>
                            Formato XML • Máximo 50MB • Processamento seguro
                        </p>
                    </div>
                    
                    <!-- Upload Area for e-Fatura -->
                    <div x-show="uploadType === 'efatura'" class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mt-0.5 mr-2"></i>
                                <div class="text-sm text-blue-800">
                                    <p class="font-medium mb-1">Instruções para exportar do e-Fatura:</p>
                                    <ol class="list-decimal list-inside space-y-1 text-xs">
                                        <li>Aceda ao Portal das Finanças > e-Fatura</li>
                                        <li>Vá para "Consultar" > "Documentos Emitidos" (vendas)</li>
                                        <li>Defina o período e clique em "Exportar para CSV"</li>
                                        <li>Repita para "Documentos Adquiridos" (compras)</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vendas CSV Upload -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <h3 class="font-medium text-gray-900">Ficheiro de Vendas (CSV)</h3>
                                    <p class="text-sm text-gray-500">Documentos emitidos do e-Fatura</p>
                                </div>
                                <i class="fas fa-file-csv text-2xl text-green-600"></i>
                            </div>
                            <input type="file" id="vendasInput" class="hidden" accept=".csv" @change="handleVendasSelect">
                            <button type="button" onclick="document.getElementById('vendasInput').click()"
                                    class="w-full py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                    :class="efaturaFiles.vendas ? 'bg-green-50 border-green-300' : ''">
                                <i class="fas fa-upload mr-2"></i>
                                <span x-text="efaturaFiles.vendas ? efaturaFiles.vendas.name : 'Selecionar ficheiro de vendas'"></span>
                            </button>
                        </div>
                        
                        <!-- Compras CSV Upload -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <h3 class="font-medium text-gray-900">Ficheiro de Compras (CSV)</h3>
                                    <p class="text-sm text-gray-500">Documentos adquiridos do e-Fatura</p>
                                </div>
                                <i class="fas fa-file-csv text-2xl text-red-600"></i>
                            </div>
                            <input type="file" id="comprasInput" class="hidden" accept=".csv" @change="handleComprasSelect">
                            <button type="button" onclick="document.getElementById('comprasInput').click()"
                                    class="w-full py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                                    :class="efaturaFiles.compras ? 'bg-green-50 border-green-300' : ''">
                                <i class="fas fa-upload mr-2"></i>
                                <span x-text="efaturaFiles.compras ? efaturaFiles.compras.name : 'Selecionar ficheiro de compras'"></span>
                            </button>
                        </div>
                        
                        <!-- Upload Button -->
                        <button type="button" @click="uploadEfaturaFiles"
                                :disabled="!efaturaFiles.vendas || !efaturaFiles.compras"
                                class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                            <i class="fas fa-upload mr-2"></i>
                            Carregar Ficheiros e-Fatura
                        </button>
                    </div>
                    
                    <!-- Demo Data Option -->
                    <div class="relative my-8">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-4 bg-white text-gray-500">ou teste com</span>
                        </div>
                    </div>
                    
                    <button type="button" @click="loadMockData"
                            class="w-full py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center">
                        <i class="fas fa-database mr-2"></i>
                        Usar Dados de Demonstração
                        <span class="ml-2 text-xs text-gray-500">(26 vendas • 157 custos)</span>
                    </button>

                    <!-- Debug Panel -->
                    <div x-data="{ showDebug: false }" class="mt-4">
                        <button @click="showDebug = !showDebug"
                                class="text-xs text-gray-500 hover:text-gray-700 flex items-center">
                            <i class="fas fa-bug mr-1"></i>
                            Debug Info
                        </button>

                        <div x-show="showDebug" x-transition class="mt-2 p-3 bg-gray-50 rounded-lg text-xs">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <strong>API URL:</strong><br>
                                    <span x-text="apiUrl" class="font-mono"></span>
                                </div>
                                <div>
                                    <strong>Session:</strong><br>
                                    <span x-text="sessionId || 'None'" class="font-mono"></span>
                                </div>
                                <div>
                                    <strong>Step:</strong><br>
                                    <span x-text="currentStep" class="font-mono"></span>
                                </div>
                                <div>
                                    <strong>Loading:</strong><br>
                                    <span x-text="loading ? 'Yes' : 'No'" class="font-mono"></span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button @click="testApiConnection()"
                                        class="px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                                    Test API
                                </button>
                                <button @click="clearSession()"
                                        class="ml-2 px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                                    Clear Session
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VAT Rate Selection -->
                    <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Taxa de IVA
                        </label>
                        <select x-model="vatRate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="23">23% - Taxa Normal (Continente)</option>
                            <option value="22">22% - Taxa Normal (Madeira)</option>
                            <option value="16">16% - Taxa Normal (Açores)</option>
                        </select>
                        <p class="text-xs text-gray-600 mt-1">
                            <i class="fas fa-info-circle"></i>
                            Regime de Margem - CIVA Art. 308º
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Associate -->
        <div x-show="currentStep === 2" class="animate-slide-up">
            <!-- Summary Cards - NOW WITH REAL-TIME UPDATES! -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-lg p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Vendas</p>
                            <p class="text-2xl font-semibold text-gray-900" x-text="'€' + totalSales.toLocaleString('pt-PT')"></p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-green-600"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <span x-text="sales.length"></span> documentos
                    </p>
                </div>
                
                <div class="bg-white rounded-lg p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Custos Associados</p>
                            <p class="text-2xl font-semibold" 
                               :class="associatedCostsTotal > 0 ? 'text-red-600' : 'text-gray-400'"
                               x-text="'€' + associatedCostsTotal.toLocaleString('pt-PT')"></p>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-receipt text-red-600"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <span x-text="totalAssociatedCosts"></span> de <span x-text="costs.length"></span> custos
                    </p>
                </div>
                
                <div class="bg-white rounded-lg p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Margem Real</p>
                            <p class="text-2xl font-semibold" 
                               :class="realMargin >= 0 ? 'text-gray-900' : 'text-red-600'"
                               x-text="'€' + realMargin.toLocaleString('pt-PT')"></p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-percentage text-blue-600"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <span x-text="realMarginPercent.toFixed(1) + '%'"></span> margem
                    </p>
                </div>
                
                <div class="bg-white rounded-lg p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">IVA Real</p>
                            <p class="text-2xl font-semibold text-gray-900" x-text="'€' + realVAT.toLocaleString('pt-PT')"></p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calculator text-purple-600"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <span x-text="vatRate + '%'"></span> sobre margem
                    </p>
                </div>
            </div>

            <!-- Real-time Preview Card -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6" x-show="hasAssociations">
                <h4 class="font-semibold text-yellow-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>Preview do Cálculo
                </h4>
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="text-yellow-700">Vendas com custos:</span>
                        <span class="font-bold text-yellow-900" x-text="salesWithCosts + ' de ' + sales.length"></span>
                    </div>
                    <div>
                        <span class="text-yellow-700">Poupança IVA:</span>
                        <span class="font-bold text-green-700" x-text="'€' + vatSavings.toFixed(2)"></span>
                    </div>
                    <div>
                        <span class="text-yellow-700">IVA s/ total seria:</span>
                        <span class="font-bold text-red-700" x-text="'€' + (totalSales * vatRate / 100).toFixed(2)"></span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Ações Rápidas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button @click="autoMatch"
                            class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left hover-lift disabled:opacity-50 disabled:cursor-not-allowed"
                            :disabled="loading">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-900">Auto-Associação</h4>
                                <p class="text-sm text-gray-600 mt-1">Associar automaticamente por datas e valores</p>
                            </div>
                            <i class="fas fa-magic text-blue-600"></i>
                        </div>
                    </button>
                    
                    <button @click="associateSelected"
                            class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left hover-lift disabled:opacity-50 disabled:cursor-not-allowed"
                            :disabled="loading || selectedSales.length === 0 || selectedCosts.length === 0">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-900">Associar Selecionados</h4>
                                <p class="text-sm text-gray-600 mt-1">
                                    <span x-text="selectedSales.length"></span> vendas • 
                                    <span x-text="selectedCosts.length"></span> custos
                                </p>
                            </div>
                            <i class="fas fa-link text-green-600"></i>
                        </div>
                    </button>
                    
                    <button @click="clearAllAssociations"
                            class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-left hover-lift disabled:opacity-50 disabled:cursor-not-allowed"
                            :disabled="!hasAssociations || loading"
                            x-show="hasAssociations">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-900">Limpar Associações</h4>
                                <p class="text-sm text-gray-600 mt-1">Remover todas as ligações</p>
                            </div>
                            <i class="fas fa-unlink text-orange-600"></i>
                        </div>
                    </button>
                    
                    <button @click="calculateAndExport"
                            :disabled="loading"
                            class="p-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-left hover-lift disabled:opacity-50 disabled:cursor-not-allowed">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium">Calcular e Exportar</h4>
                                <p class="text-sm opacity-90 mt-1">Gerar relatório Excel</p>
                            </div>
                            <i class="fas fa-file-excel"></i>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Documents Lists -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Sales List -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Vendas</h3>
                            <span class="text-sm text-gray-500">
                                <span x-text="sales.length"></span> documentos
                            </span>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center cursor-pointer text-sm text-gray-600">
                                <input type="checkbox" @change="toggleAllSales" class="mr-2">
                                Selecionar todas
                            </label>
                            <input type="text" x-model="salesSearch" 
                                   placeholder="Pesquisar..." 
                                   class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="max-h-96 overflow-y-auto">
                        <template x-for="sale in filteredSales" :key="sale.id">
                            <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors"
                                 :class="{
                                     'bg-blue-50': selectedSales.includes(sale.id),
                                     'has-associations': sale.linked_costs.length > 0
                                 }"
                                 @click="toggleSale(sale.id)">
                                <div class="flex items-start">
                                    <input type="checkbox" 
                                           :checked="selectedSales.includes(sale.id)"
                                           @click.stop
                                           @change="toggleSale(sale.id)"
                                           class="mt-1 mr-3">
                                    <div class="w-8 h-8 rounded-md bg-slate-100 flex items-center justify-center mr-3">
                                        <i :class="[getSaleIcon(sale), getSaleIconColor(sale)]"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <p class="font-medium text-gray-900" x-text="sale.number"></p>
                                                <p class="text-sm text-gray-600" x-text="sale.client"></p>
                                                <p class="text-xs text-gray-500 mt-1" x-text="formatDate(sale.date)"></p>
                                            </div>
                                            <p class="font-semibold" 
                                               :class="sale.amount >= 0 ? 'text-green-600' : 'text-red-600'"
                                               x-text="'€' + sale.amount.toLocaleString('pt-PT', {minimumFractionDigits: 2})"></p>
                                        </div>
                                        
                                        <!-- Linked Costs -->
                                        <div x-show="sale.linked_costs.length > 0" class="mt-2">
                                            <div class="flex items-center text-xs text-green-700">
                                                <i class="fas fa-check-circle mr-1"></i>
                                                <span x-text="sale.linked_costs.length + ' custos associados'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Costs List -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Custos</h3>
                            <span class="text-sm text-gray-500">
                                <span x-text="costs.length"></span> documentos
                            </span>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center cursor-pointer text-sm text-gray-600">
                                <input type="checkbox" @change="toggleAllCosts" class="mr-2">
                                Selecionar todos
                            </label>
                            <input type="text" x-model="costsSearch" 
                                   placeholder="Pesquisar..." 
                                   class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="max-h-96 overflow-y-auto">
                        <template x-for="cost in filteredCosts" :key="cost.id">
                            <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors"
                                 :class="{
                                     'bg-blue-50': selectedCosts.includes(cost.id),
                                     'has-associations': cost.linked_sales.length > 0
                                 }"
                                 @click="toggleCost(cost.id)">
                                <div class="flex items-start">
                                    <input type="checkbox" 
                                           :checked="selectedCosts.includes(cost.id)"
                                           @click.stop
                                           @change="toggleCost(cost.id)"
                                           class="mt-1 mr-3">
                                    <div class="flex-1">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <div class="flex items-center">
                                                    <template x-if="cost.icon">
                                                        <span class="mr-2 text-lg" x-text="cost.icon"></span>
                                                    </template>
                                                    <template x-if="!cost.icon">
                                                        <i :class="[getSupplierIcon(cost.supplier), getSupplierIconColor(cost.supplier), 'mr-2']"></i>
                                                    </template>
                                                    <p class="font-medium text-gray-900" x-text="cost.supplier"></p>
                                                </div>
                                                <p class="text-sm text-gray-600 ml-6" x-text="cost.description"></p>
                                                <p class="text-xs text-gray-500 mt-1 ml-6">
                                                    <span x-text="formatDate(cost.date)"></span> • 
                                                    <span x-text="cost.document_number"></span>
                                                </p>
                                            </div>
                                            <p class="font-semibold text-red-600"
                                               x-text="'€' + cost.amount.toLocaleString('pt-PT', {minimumFractionDigits: 2})"></p>
                                        </div>
                                        
                                        <!-- Linked Sales -->
                                        <div x-show="cost.linked_sales.length > 0" class="mt-2">
                                            <div class="flex items-center text-xs text-green-700">
                                                <i class="fas fa-check-circle mr-1"></i>
                                                <span x-text="'Associado a ' + cost.linked_sales.length + ' venda(s)'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div x-show="currentStep === 3" class="animate-slide-up">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                <h2 class="text-2xl font-semibold text-gray-900 mb-6">Resultados do Cálculo</h2>
                
                <!-- Calculation Mode Selector -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-blue-900">
                            <i class="fas fa-calculator mr-2"></i>
                            Modo de Cálculo
                        </h3>
                        <div class="flex space-x-2">
                            <button @click="calculationMode = 'transaction'" 
                                    :class="calculationMode === 'transaction' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors">
                                Por Transação
                            </button>
                            <button @click="calculationMode = 'period'" 
                                    :class="calculationMode === 'period' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-colors">
                                Por Período
                            </button>
                        </div>
                    </div>
                    
                    <!-- Period Selection -->
                    <div x-show="calculationMode === 'period'" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Início</label>
                            <input type="date" x-model="periodStart" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Fim</label>
                            <input type="date" x-model="periodEnd" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Região</label>
                            <select x-model="vatRegion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="continental">Continental (23%)</option>
                                <option value="madeira">Madeira (22%)</option>
                                <option value="azores">Açores (18%)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Previous Negative Margin -->
                    <div x-show="calculationMode === 'period'" class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Margem Negativa Anterior (se aplicável)
                        </label>
                        <div class="flex items-center">
                            <span class="mr-2">€</span>
                            <input type="number" x-model="previousNegativeMargin" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="0.00" step="0.01">
                        </div>
                        <p class="text-xs text-gray-600 mt-1">
                            <i class="fas fa-info-circle"></i>
                            Insira o valor absoluto da margem negativa a compensar
                        </p>
                    </div>
                    
                    <!-- Recalculate Button -->
                    <div x-show="calculationMode === 'period'" class="mt-4">
                        <button @click="calculatePeriodVAT" 
                                class="w-full py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
                                :disabled="loading">
                            <i class="fas fa-calculator mr-2"></i>
                            Calcular IVA por Período
                        </button>
                    </div>
                </div>
                
                <!-- Calculation Mode Indicator -->
                <div class="mb-6 p-4 rounded-lg border-2" 
                     :class="calculationMode === 'period' ? 'bg-blue-50 border-blue-300' : 'bg-gray-50 border-gray-300'">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="mr-3 text-2xl" 
                               :class="calculationMode === 'period' ? 'fas fa-calendar-alt text-blue-600' : 'fas fa-calculator text-gray-600'"></i>
                            <div>
                                <h4 class="font-semibold" 
                                    :class="calculationMode === 'period' ? 'text-blue-900' : 'text-gray-900'">
                                    <span x-text="calculationMode === 'period' ? 'Cálculo por Período Fiscal' : 'Cálculo por Transação'"></span>
                                </h4>
                                <p class="text-sm" 
                                   :class="calculationMode === 'period' ? 'text-blue-700' : 'text-gray-600'"
                                   x-text="calculationMode === 'period' ? 'Com compensação de margens negativas entre períodos' : 'Cálculo individual por documento'">
                                </p>
                            </div>
                        </div>
                        <div x-show="calculationMode === 'period'" class="text-right">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-check-circle mr-1"></i>
                                Conforme Art. 308º CIVA
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Results Summary Corporate -->
                <!-- Professional KPI Dashboard - Advantage Style -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-8">
                    <div class="modern-card interactive-element data-point text-center p-6">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fas fa-euro-sign text-green-600 text-lg"></i>
                        </div>
                        <p class="text-sm font-semibold text-corporate mb-2">Total Vendas</p>
                        <p class="text-2xl font-bold gradient-corporate"
                           x-text="'€' + (finalResults.totalSales || 0).toLocaleString('pt-PT')"></p>
                        <div class="mt-3 progress-modern">
                            <div class="progress-bar" style="width: 100%"></div>
                        </div>
                    </div>

                    <div class="modern-card interactive-element data-point text-center p-6">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-red-100 flex items-center justify-center">
                            <i class="fas fa-receipt text-red-600 text-lg"></i>
                        </div>
                        <p class="text-sm font-semibold text-corporate mb-2">Total Custos</p>
                        <p class="text-2xl font-bold text-red-600"
                           x-text="'€' + (finalResults.totalCosts || 0).toLocaleString('pt-PT')"></p>
                        <div class="mt-3 progress-modern">
                            <div class="progress-bar bg-red-500" style="width: 75%"></div>
                        </div>
                    </div>

                    <div class="modern-card interactive-element data-point text-center p-6">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-blue-100 flex items-center justify-center">
                            <i :class="calculationMode === 'period' ? 'fas fa-balance-scale' : 'fas fa-chart-bar'" class="text-blue-600 text-lg"></i>
                        </div>
                        <p class="text-sm font-semibold text-corporate mb-2" x-text="calculationMode === 'period' ? 'Margem Compensada' : 'Margem Bruta'"></p>
                        <p class="text-2xl font-bold text-blue-600"
                           x-text="'€' + ((calculationMode === 'period' ? finalResults.compensatedMargin : finalResults.grossMargin) || 0).toLocaleString('pt-PT')"></p>
                        <div class="mt-3 progress-modern">
                            <div class="progress-bar bg-blue-500" style="width: 85%"></div>
                        </div>
                    </div>

                    <div class="modern-card interactive-element data-point text-center p-6">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-purple-100 flex items-center justify-center">
                            <i class="fas fa-university text-purple-600 text-lg"></i>
                        </div>
                        <p class="text-sm font-semibold text-corporate mb-2">IVA (<span x-text="vatRate"></span>%)</p>
                        <p class="text-2xl font-bold text-purple-600"
                           x-text="'€' + (finalResults.totalVAT || 0).toLocaleString('pt-PT')"></p>
                        <div class="mt-3 progress-modern">
                            <div class="progress-bar bg-purple-500" style="width: 65%"></div>
                        </div>
                    </div>

                    <div class="modern-card interactive-element data-point text-center p-6 border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-white">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-cyan-100 flex items-center justify-center">
                            <i class="fas fa-trophy text-cyan-600 text-lg"></i>
                        </div>
                        <p class="text-sm font-semibold text-corporate mb-2">Margem Líquida</p>
                        <p class="text-2xl font-bold gradient-corporate"
                           x-text="'€' + (finalResults.netMargin || 0).toLocaleString('pt-PT')"></p>
                        <div class="mt-3 progress-modern">
                            <div class="progress-bar bg-gradient-to-r from-cyan-500 to-blue-500" style="width: 90%"></div>
                        </div>
                        <div class="mt-2">
                            <span class="status-success text-xs">Resultado Final</span>
                        </div>
                    </div>
                </div>
                
                <!-- Period Calculation Results -->
                <div x-show="calculationMode === 'period' && periodResults" class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-8">
                    <h3 class="text-lg font-semibold text-yellow-900 mb-4">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        Resultados do Cálculo por Período
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-600">Período</p>
                            <p class="font-semibold" x-text="periodResults ? `${new Date(periodResults.period.start).toLocaleDateString('pt-PT')} a ${new Date(periodResults.period.end).toLocaleDateString('pt-PT')}` : ''"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Região</p>
                            <p class="font-semibold" x-text="periodResults ? periodResults.region : ''"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Taxa IVA</p>
                            <p class="font-semibold" x-text="periodResults ? periodResults.vat_rate + '%' : ''"></p>
                        </div>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Margem Bruta do Período:</span>
                            <span class="font-semibold" x-text="periodResults && periodResults.totals ? '€' + Number(periodResults.totals.gross_margin || 0).toFixed(2) : ''"></span>
                        </div>
                        <div class="flex justify-between" x-show="periodResults && periodResults.totals && periodResults.totals.previous_negative > 0">
                            <span>(-) Margem Negativa Anterior:</span>
                            <span class="font-semibold text-red-600" x-text="periodResults && periodResults.totals ? '€' + Number(periodResults.totals.previous_negative || 0).toFixed(2) : ''"></span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span>Margem Compensada:</span>
                            <span class="font-bold" x-text="periodResults && periodResults.totals ? '€' + Number(periodResults.totals.compensated_margin || 0).toFixed(2) : ''"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Base Tributável:</span>
                            <span class="font-semibold" x-text="periodResults && periodResults.totals ? '€' + Number(periodResults.totals.vat_base || 0).toFixed(2) : ''"></span>
                        </div>
                        <div class="flex justify-between text-lg font-bold border-t pt-2">
                            <span>IVA a Pagar:</span>
                            <span class="text-green-600" x-text="periodResults && periodResults.totals ? '€' + Number(periodResults.totals.vat_amount || 0).toFixed(2) : ''"></span>
                        </div>
                        <div x-show="periodResults && periodResults.totals && periodResults.totals.carry_forward < 0" class="mt-4 p-3 bg-orange-100 rounded">
                            <p class="text-sm text-orange-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Margem negativa a compensar no próximo período: 
                                <span class="font-bold">€<span x-text="periodResults && periodResults.totals ? Math.abs(Number(periodResults.totals.carry_forward || 0)).toFixed(2) : '0.00'"></span></span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Main Charts Section - Aligned with PDF -->
                <div class="space-y-8 mb-8">
                    <!-- Bar Chart - Financial Analysis -->
                    <div class="chart-container interactive-element float-animation">
                        <h3 class="text-xl font-semibold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-6 flex items-center">
                            <i class="fas fa-chart-bar mr-3 text-blue-600 pulse-subtle"></i>
                            💰 Análise Financeira Completa
                        </h3>
                        <div class="relative h-96 data-point">
                            <canvas id="marginChart" class="relative z-10"></canvas>
                        </div>
                    </div>
                    
                    <!-- Distribution and Comparison Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Pie Chart - Value Distribution -->
                        <div class="chart-container interactive-element">
                            <h3 class="text-lg font-bold heading-corporate mb-4 flex items-center">
                                <i class="fas fa-chart-pie mr-3 text-blue-600"></i>
                                Distribuição de Valores
                            </h3>
                            <div class="relative h-64 data-point">
                                <canvas id="marginPieChart" class="relative z-10"></canvas>
                            </div>
                            <!-- Custom Legend - Modernized -->
                            <div class="mt-6 space-y-3" id="pieLegend">
                                <div class="flex items-center justify-between text-sm interactive-element p-2 rounded-lg hover:bg-white hover:bg-opacity-50 transition-all duration-300">
                                    <div class="flex items-center">
                                        <span class="w-5 h-5 rounded-full mr-3 shadow-lg" style="background: linear-gradient(135deg, rgba(6, 182, 212, 1) 0%, rgba(34, 211, 238, 0.8) 100%)"></span>
                                        <span class="font-medium text-gray-700">✨ Margem Líquida</span>
                                    </div>
                                    <span class="font-bold text-cyan-600" x-text="'€' + (finalResults.netMargin || 0).toLocaleString('pt-PT', {minimumFractionDigits: 2})"></span>
                                </div>
                                <div class="flex items-center justify-between text-sm interactive-element p-2 rounded-lg hover:bg-white hover:bg-opacity-50 transition-all duration-300">
                                    <div class="flex items-center">
                                        <span class="w-5 h-5 rounded-full mr-3 shadow-lg" style="background: linear-gradient(135deg, rgba(147, 51, 234, 1) 0%, rgba(168, 85, 247, 0.8) 100%)"></span>
                                        <span class="font-medium text-gray-700">🏛️ IVA</span>
                                    </div>
                                    <span class="font-bold text-purple-600" x-text="'€' + (finalResults.totalVAT || 0).toLocaleString('pt-PT', {minimumFractionDigits: 2})"></span>
                                </div>
                                <div class="flex items-center justify-between text-sm interactive-element p-2 rounded-lg hover:bg-white hover:bg-opacity-50 transition-all duration-300">
                                    <div class="flex items-center">
                                        <span class="w-5 h-5 rounded-full mr-3 shadow-lg" style="background: linear-gradient(135deg, rgba(239, 68, 68, 1) 0%, rgba(248, 113, 113, 0.8) 100%)"></span>
                                        <span class="font-medium text-gray-700">📋 Custos</span>
                                    </div>
                                    <span class="font-bold text-red-600" x-text="'€' + (finalResults.totalCosts || 0).toLocaleString('pt-PT', {minimumFractionDigits: 2})"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comparison Chart - Normal VAT vs Margin VAT -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                                <i class="fas fa-balance-scale mr-2 text-purple-600"></i>
                                Comparação: IVA Normal vs IVA Margem
                            </h3>
                            <div style="position: relative; height: 300px;">
                                <canvas id="comparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-center space-x-4">
                    <button @click="currentStep = 2" 
                            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar
                    </button>
                    
                    <button @click="downloadExcel()"
                            class="btn-primary-corporate interactive-element flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>
                        Exportar Excel
                    </button>

                    <button @click="previewPDF()"
                            class="btn-secondary-corporate interactive-element flex items-center">
                        <i class="fas fa-eye mr-2"></i>
                        Pré-visualizar PDF
                    </button>

                    <button @click="downloadPDF()"
                            class="btn-secondary-corporate interactive-element flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i>
                        Exportar PDF
                    </button>

                    <button @click="startNew()"
                            class="btn-secondary-corporate interactive-element flex items-center">
                        <i class="fas fa-plus mr-2"></i>
                        Nova Análise
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div x-show="loading" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-700" x-text="loadingMessage">A processar...</p>
        </div>
    </div>

    <!-- Notifications -->
    <div class="fixed bottom-4 right-4 z-50 space-y-4">
        <template x-for="(notification, index) in notifications" :key="index">
            <div x-show="notification.show"
                 x-transition:enter="transform ease-out duration-300 transition"
                 x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
                 x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
                 x-transition:leave="transition ease-in duration-100"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto">
                <div class="rounded-lg shadow-xs overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="text-xl"
                                   :class="{
                                       'fas fa-check-circle text-green-500': notification.type === 'success',
                                       'fas fa-exclamation-circle text-red-500': notification.type === 'error',
                                       'fas fa-exclamation-triangle text-yellow-500': notification.type === 'warning',
                                       'fas fa-info-circle text-blue-500': notification.type === 'info'
                                   }"></i>
                            </div>
                            <div class="ml-3 w-0 flex-1">
                                <p class="text-sm font-medium text-gray-900" x-text="notification.title"></p>
                                <p class="mt-1 text-sm text-gray-500" x-text="notification.message"></p>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex">
                                <button @click="removeNotification(index)" 
                                        class="inline-flex text-gray-400 hover:text-gray-500 focus:outline-none">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Modern Chart Libraries 2025 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-gradient@0.6.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>

    <!-- Framer Motion for micro-animations -->
    <!-- Removed framer-motion (React-only lib) to avoid runtime errors in plain HTML app -->

    <!-- GSAP for premium animations -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

    <script src="advanced_charts.js"></script>
    
    <!-- Alpine.js App -->
    <script>
        function ivaApp() {
            return {
                // API Configuration: treat localhost/127.0.0.1/0.0.0.0 or port 3000 as dev
                apiUrl: ((['localhost','127.0.0.1','0.0.0.0'].includes(window.location.hostname))
                        || window.location.port === '3000'
                        || window.location.protocol === 'file:')
                    ? 'http://localhost:8000'
                    : '/api',
                
                // App State
                currentStep: 1,
                sessionId: null,
                loading: false,
                loadingMessage: 'A processar...',
                dragOver: false,
                uploadType: 'saft', // 'saft' or 'efatura'
                efaturaFiles: {
                    vendas: null,
                    compras: null
                },
                
                // Data
                sales: [],
                costs: [],
                selectedSales: [],
                selectedCosts: [],
                vatRate: 23,
                
                // Search
                salesSearch: '',
                costsSearch: '',
                
                // Results
                finalResults: {},
                
                // Period calculation
                calculationMode: 'transaction',
                periodStart: '',
                periodEnd: '',
                vatRegion: 'continental',
                previousNegativeMargin: 0,
                periodResults: null,
                
                // Notifications
                notifications: [],
                
                // NEW: Real-time computed properties for associated costs
                get associatedCostsTotal() {
                    let total = 0;
                    
                    // Calculate total of costs that are associated with at least one sale
                    this.costs.forEach(cost => {
                        if (cost.linked_sales && cost.linked_sales.length > 0) {
                            // If cost is linked to multiple sales, we still count it once
                            total += cost.amount;
                        }
                    });
                    
                    return total;
                },
                
                get totalAssociatedCosts() {
                    return this.costs.filter(c => c.linked_sales && c.linked_sales.length > 0).length;
                },
                
                get salesWithCosts() {
                    return this.sales.filter(s => s.linked_costs && s.linked_costs.length > 0).length;
                },
                
                get hasAssociations() {
                    return this.salesWithCosts > 0;
                },
                
                // Original computed properties
                get totalSales() {
                    return this.sales.reduce((sum, sale) => sum + sale.amount, 0);
                },
                
                get totalCosts() {
                    return this.costs.reduce((sum, cost) => sum + cost.amount, 0);
                },
                
                // NEW: Real margin based on associations
                get realMargin() {
                    return this.totalSales - this.associatedCostsTotal;
                },
                
                get realMarginPercent() {
                    return this.totalSales !== 0 ? (this.realMargin / this.totalSales) * 100 : 0;
                },
                
                get realVAT() {
                    return this.realMargin > 0 ? this.realMargin * this.vatRate / 100 : 0;
                },
                
                get vatSavings() {
                    const vatOnTotal = this.totalSales * this.vatRate / 100;
                    return vatOnTotal - this.realVAT;
                },
                
                // Old computed properties (for comparison)
                get estimatedMargin() {
                    return this.totalSales - this.totalCosts;
                },
                
                get estimatedVAT() {
                    const margin = this.estimatedMargin;
                    return margin > 0 ? margin * this.vatRate / 100 : 0;
                },
                
                get filteredSales() {
                    if (!this.salesSearch) return this.sales;
                    const search = this.salesSearch.toLowerCase();
                    return this.sales.filter(sale => 
                        sale.number.toLowerCase().includes(search) ||
                        sale.client.toLowerCase().includes(search)
                    );
                },
                
                get filteredCosts() {
                    if (!this.costsSearch) return this.costs;
                    const search = this.costsSearch.toLowerCase();
                    return this.costs.filter(cost => 
                        cost.supplier.toLowerCase().includes(search) ||
                        cost.description.toLowerCase().includes(search)
                    );
                },
                
                // Initialize
                init() {
                    // Check for saved session
                    const savedSession = localStorage.getItem('ivaSession');
                    if (savedSession) {
                        const data = JSON.parse(savedSession);
                        this.sessionId = data.sessionId;
                        this.sales = data.sales || [];
                        this.costs = data.costs || [];
                        if (this.sales.length > 0 || this.costs.length > 0) {
                            this.currentStep = 2;
                        }
                    }
                },
                
                // Enhanced fetch with timeout, retries and detailed error handling
                async apiFetch(url, options = {}, timeoutMs = 30000, retries = 1) {
                    for (let attempt = 0; attempt <= retries; attempt++) {
                        const controller = new AbortController();
                        const t = setTimeout(() => controller.abort(), timeoutMs);

                        try {
                            console.log(`[API Call] ${options.method || 'GET'} ${url} (attempt ${attempt + 1})`);

                            const res = await fetch(url, {
                                ...options,
                                signal: controller.signal,
                                headers: {
                                    ...options.headers
                                }
                            });

                            clearTimeout(t);

                            if (!res.ok) {
                                console.error(`[API Error] ${res.status} ${res.statusText} for ${url}`);

                                if (res.status === 405) {
                                    throw new Error(`Método HTTP incorreto. Endpoint: ${url}, Método: ${options.method || 'GET'}`);
                                }
                                if (res.status >= 500 && attempt < retries) {
                                    console.log(`Server error, retrying... (${attempt + 1}/${retries + 1})`);
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                    continue;
                                }
                            }

                            console.log(`[API Success] ${res.status} for ${url}`);
                            return res;

                        } catch (error) {
                            clearTimeout(t);

                            if (error.name === 'AbortError') {
                                console.error(`[API Timeout] Request to ${url} timed out after ${timeoutMs}ms`);
                                throw new Error(`Request timeout (${timeoutMs/1000}s). Por favor tente novamente.`);
                            }

                            if (attempt === retries) {
                                console.error(`[API Final Error] ${error.message} for ${url}`);
                                throw error;
                            }

                            console.log(`Network error, retrying... (${attempt + 1}/${retries + 1})`);
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                },
                
                // File Handling
                handleDrop(event) {
                    this.dragOver = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.name.endsWith('.xml')) {
                        this.uploadFile(file);
                    } else {
                        this.showNotification('Erro', 'Por favor selecione um ficheiro XML', 'error');
                    }
                },
                
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.uploadFile(file);
                    }
                },
                
                // Unified CSV file handler with validation
                handleCSVFile(event, type) {
                    const file = event.target.files[0];
                    if (!file) return;

                    // File type validation
                    if (!file.name.endsWith('.csv')) {
                        this.showNotification('Erro', 'Por favor selecione um ficheiro CSV', 'error');
                        return;
                    }

                    // File size validation (50MB limit)
                    const maxSize = 50 * 1024 * 1024;
                    if (file.size > maxSize) {
                        this.showNotification('Erro', 'Ficheiro muito grande (máximo 50MB)', 'error');
                        return;
                    }

                    // Store file based on type
                    if (type === 'vendas') {
                        this.efaturaFiles.vendas = file;
                        console.log('[CSV] Vendas file selected:', file.name, `${(file.size/1024).toFixed(1)}KB`);
                    } else if (type === 'compras') {
                        this.efaturaFiles.compras = file;
                        console.log('[CSV] Compras file selected:', file.name, `${(file.size/1024).toFixed(1)}KB`);
                    }
                },

                // Legacy handlers (for backward compatibility)
                handleVendasSelect(event) {
                    this.handleCSVFile(event, 'vendas');
                },
                handleComprasSelect(event) {
                    this.handleCSVFile(event, 'compras');
                },
                async uploadEfaturaFiles() {
                    if (!this.efaturaFiles.vendas || !this.efaturaFiles.compras) {
                        this.showNotification('Aviso', 'Selecione ambos os ficheiros (vendas e compras)', 'warning');
                        return;
                    }

                    // Files already validated by handleCSVFile

                    this.loading = true;
                    this.loadingMessage = 'A processar ficheiros e‑Fatura...';

                    try {
                        console.log('[e-Fatura] Starting file upload...');
                        console.log(`[e-Fatura] Vendas: ${this.efaturaFiles.vendas.name} (${this.efaturaFiles.vendas.size} bytes)`);
                        console.log(`[e-Fatura] Compras: ${this.efaturaFiles.compras.name} (${this.efaturaFiles.compras.size} bytes)`);

                        const formData = new FormData();
                        formData.append('vendas', this.efaturaFiles.vendas);
                        formData.append('compras', this.efaturaFiles.compras);

                        const response = await this.apiFetch(`${this.apiUrl}/api/upload-efatura`, {
                            method: 'POST',
                            body: formData
                        }, 60000); // 60 second timeout for large files

                        if (!response.ok) {
                            let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.detail || errorData.message || errorMessage;
                            } catch (_) {
                                // If response is not JSON, use status text
                            }
                            throw new Error(errorMessage);
                        }

                        const data = await response.json();

                        if (!data.session_id) {
                            throw new Error('Resposta inválida do servidor (missing session_id)');
                        }

                        this.sessionId = data.session_id;
                        this.sales = data.sales || [];
                        this.costs = data.costs || [];

                        console.log(`[e-Fatura] Successfully imported ${this.sales.length} sales and ${this.costs.length} costs`);

                        this.saveSession();

                        this.showNotification(
                            'Ficheiros Importados!',
                            `${this.sales.length} vendas e ${this.costs.length} custos importados com sucesso`,
                            'success'
                        );

                        this.currentStep = 2;

                    } catch (error) {
                        console.error('[e-Fatura Error]:', error);

                        let userMessage = 'Erro ao processar ficheiros e-Fatura';

                        if (error.message.includes('timeout')) {
                            userMessage = 'Upload demorou muito tempo. Tente ficheiros menores ou verifique a conexão.';
                        } else if (error.message.includes('400')) {
                            userMessage = 'Formato de ficheiro inválido. Verifique se são ficheiros CSV válidos.';
                        } else if (error.message.includes('413')) {
                            userMessage = 'Ficheiros muito grandes. Tente ficheiros menores.';
                        } else if (error.message.includes('500')) {
                            userMessage = 'Erro interno do servidor. Tente novamente em alguns minutos.';
                        } else if (error.message.includes('fetch')) {
                            userMessage = 'Erro de conexão. Verifique se o backend está a funcionar.';
                        }

                        this.showNotification('Erro de Import', userMessage, 'error');

                    } finally {
                        this.loading = false;
                        this.loadingMessage = '';
                    }
                },
                async uploadFile(file) {
                    this.loading = true;
                    this.loadingMessage = 'A carregar ficheiro SAF-T...';
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error('Erro no upload');
                        }
                        
                        const data = await response.json();
                        
                        this.sessionId = data.session_id;
                        this.sales = data.sales;
                        this.costs = data.costs;
                        
                        this.saveSession();
                        
                        this.showNotification(
                            'Sucesso!', 
                            `Importados ${data.summary.total_sales} vendas e ${data.summary.total_costs} custos`,
                            'success'
                        );
                        
                        this.currentStep = 2;
                        
                    } catch (error) {
                        console.error('Upload error:', error);
                        this.showNotification('Erro', 'Erro ao carregar ficheiro', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // Mock Data with enhanced error handling
                async loadMockData() {
                    this.loading = true;
                    this.loadingMessage = 'A carregar dados de demonstração...';

                    try {
                        console.log('[Mock Data] Starting mock data load...');

                        const response = await this.apiFetch(`${this.apiUrl}/api/mock-data`, {
                            method: 'GET'
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();

                        if (!data.session_id || !data.sales || !data.costs) {
                            throw new Error('Dados de resposta inválidos do servidor');
                        }

                        this.sessionId = data.session_id;
                        this.sales = data.sales;
                        this.costs = data.costs;

                        console.log(`[Mock Data] Loaded ${this.sales.length} sales and ${this.costs.length} costs`);

                        this.saveSession();

                        this.showNotification(
                            'Dados Carregados',
                            `${this.sales.length} vendas e ${this.costs.length} custos carregados`,
                            'success'
                        );

                        this.currentStep = 2;

                    } catch (error) {
                        console.error('[Mock Data Error]:', error);
                        let errorMessage = 'Erro ao carregar dados de demonstração';

                        if (error.message.includes('timeout')) {
                            errorMessage = 'Timeout na conexão. Verifique se o backend está a funcionar.';
                        } else if (error.message.includes('405')) {
                            errorMessage = 'Erro de configuração do servidor (método HTTP incorreto)';
                        } else if (error.message.includes('fetch')) {
                            errorMessage = 'Erro de conexão. Verifique se o backend está a funcionar na porta 8000.';
                        }

                        this.showNotification('Erro de Dados Demo', errorMessage, 'error');
                    } finally {
                        this.loading = false;
                        this.loadingMessage = '';
                    }
                },
                
                // Selection Methods
                toggleSale(id) {
                    const index = this.selectedSales.indexOf(id);
                    if (index > -1) {
                        this.selectedSales.splice(index, 1);
                    } else {
                        this.selectedSales.push(id);
                    }
                },
                
                toggleCost(id) {
                    const index = this.selectedCosts.indexOf(id);
                    if (index > -1) {
                        this.selectedCosts.splice(index, 1);
                    } else {
                        this.selectedCosts.push(id);
                    }
                },
                
                toggleAllSales(event) {
                    if (event.target.checked) {
                        this.selectedSales = this.sales.map(s => s.id);
                    } else {
                        this.selectedSales = [];
                    }
                },
                
                toggleAllCosts(event) {
                    if (event.target.checked) {
                        this.selectedCosts = this.costs.map(c => c.id);
                    } else {
                        this.selectedCosts = [];
                    }
                },
                
                // Association Methods
                async associateSelected() {
                    if (!this.sessionId) {
                        this.showNotification('Erro', 'Sessão não encontrada. Por favor, carregue os dados primeiro.', 'error');
                        return;
                    }
                    
                    if (this.selectedSales.length === 0 || this.selectedCosts.length === 0) {
                        this.showNotification('Aviso', 'Selecione vendas e custos para associar', 'warning');
                        return;
                    }
                    
                    this.loading = true;
                    this.loadingMessage = 'A criar associações...';
                    
                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/associate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                sale_ids: this.selectedSales,
                                cost_ids: this.selectedCosts
                            })
                        }, 15000);
                        
                        const result = await response.json();
                        
                        // Update local data
                        this.selectedSales.forEach(saleId => {
                            const sale = this.sales.find(s => s.id === saleId);
                            if (sale) {
                                sale.linked_costs = [...new Set([...sale.linked_costs, ...this.selectedCosts])];
                            }
                        });
                        
                        this.selectedCosts.forEach(costId => {
                            const cost = this.costs.find(c => c.id === costId);
                            if (cost) {
                                cost.linked_sales = [...new Set([...cost.linked_sales, ...this.selectedSales])];
                            }
                        });
                        
                        this.selectedSales = [];
                        this.selectedCosts = [];
                        
                        this.saveSession();
                        
                        this.showNotification(
                            'Sucesso!',
                            `${result.associations_made} associações criadas`,
                            'success'
                        );
                        
                    } catch (error) {
                        console.error('Association error:', error);
                        this.showNotification('Erro', 'Erro ao criar associações', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async autoMatch() {
                    this.loading = true;
                    this.loadingMessage = 'A analisar e associar documentos...';
                    
                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/auto-match`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                threshold: 60
                            })
                        }, 15000);
                        
                        const result = await response.json();
                        
                        // Reload session data to get updated associations
                        await this.reloadSession();
                        
                        this.showNotification(
                            'Auto-Associação Completa',
                            `${result.matches_found} associações criadas automaticamente`,
                            'success'
                        );
                        
                    } catch (error) {
                        console.error('Auto-match error:', error);
                        this.showNotification('Erro', 'Erro na auto-associação', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async clearAllAssociations() {
                    if (!confirm('Tem certeza que deseja limpar todas as associações?')) {
                        return;
                    }
                    
                    this.loading = true;
                    this.loadingMessage = 'A limpar associações...';
                    
                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/clear-associations`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: this.sessionId
                            })
                        }, 10000);
                        
                        const result = await response.json();
                        
                        // Clear local associations
                        this.sales.forEach(sale => sale.linked_costs = []);
                        this.costs.forEach(cost => cost.linked_sales = []);
                        
                        this.saveSession();
                        
                        this.showNotification(
                            'Associações Limpas',
                            `${result.associations_cleared} associações removidas`,
                            'success'
                        );
                        
                    } catch (error) {
                        console.error('Clear associations error:', error);
                        this.showNotification('Erro', 'Erro ao limpar associações', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // Period VAT Calculation
                async calculatePeriodVAT() {
                    if (!this.sessionId) {
                        this.showNotification('Erro', 'Sessão não encontrada', 'error');
                        return;
                    }
                    
                    if (!this.periodStart || !this.periodEnd) {
                        this.showNotification('Erro', 'Por favor selecione as datas do período', 'error');
                        return;
                    }
                    
                    this.loading = true;
                    this.loadingMessage = 'A calcular IVA por período com compensação...';
                    
                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/calculate-period`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                start_date: this.periodStart,
                                end_date: this.periodEnd,
                                region: this.vatRegion,
                                previous_negative_margin: this.previousNegativeMargin || 0
                            })
                        }, 20000);
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Erro no cálculo');
                        }
                        
                        const result = await response.json();
                        this.periodResults = result;
                        
                        // Update final results with period calculation
                        this.finalResults = {
                            ...this.finalResults,
                            totalSales: result.totals.sales,
                            totalCosts: result.totals.costs,
                            grossMargin: result.totals.gross_margin,
                            totalVAT: result.totals.vat_amount,
                            netMargin: result.totals.gross_margin - result.totals.vat_amount,
                            calculationType: 'period',
                            period: result.period,
                            compensatedMargin: result.totals.compensated_margin,
                            previousNegative: result.totals.previous_negative,
                            carryForward: result.totals.carry_forward
                        };
                        
                        // Show results notification
                        if (result.totals.carry_forward < 0) {
                            this.showNotification(
                                'Cálculo por Período Completo',
                                `Margem negativa de €${Math.abs(result.totals.carry_forward).toFixed(2)} a compensar no próximo período`,
                                'warning'
                            );
                        } else {
                            this.showNotification(
                                'Cálculo por Período Completo',
                                `IVA a pagar: €${result.totals.vat_amount.toFixed(2)}`,
                                'success'
                            );
                        }
                        
                    } catch (error) {
                        console.error('Period calculation error:', error);
                        this.showNotification('Erro', error.message || 'Erro no cálculo por período', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // Calculation Methods
                async calculateAndExport() {
                    if (!this.sessionId) {
                        this.showNotification('Erro', 'Sessão não encontrada. Por favor, carregue os dados primeiro.', 'error');
                        return;
                    }
                    
                    this.loading = true;
                    this.loadingMessage = 'A calcular IVA e gerar relatório...';

                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/calculate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                vat_rate: this.vatRate
                            })
                        }, 25000);
                        
                        if (!response.ok) {
                            throw new Error('Erro no cálculo');
                        }
                        
                        // Get file blob
                        const blob = await response.blob();
                        
                        // Create download link
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `iva_margem_${new Date().toISOString().split('T')[0]}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        // Calculate summary for display
                        this.calculateSummary();
                        
                        this.showNotification(
                            'Excel Gerado!',
                            'Relatório descarregado com sucesso',
                            'success'
                        );
                        
                        this.currentStep = 3;
                        
                        // Draw chart after DOM update
                        this.$nextTick(() => {
                            try {
                                this.drawChart();
                            } catch (e) {
                                console.error('Chart error:', e);
                            }
                        });
                        
                    } catch (error) {
                        console.error('Calculation error:', error);
                        this.showNotification('Erro', 'Erro ao calcular IVA', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                calculateSummary() {
                    // Calculate totals for display
                    let totalSales = 0;
                    let totalCosts = 0;
                    
                    this.sales.forEach(sale => {
                        totalSales += sale.amount;
                    });
                    
                    this.costs.forEach(cost => {
                        // Only count costs that are linked to sales
                        if (cost.linked_sales && cost.linked_sales.length > 0) {
                            // Distribute cost proportionally
                            totalCosts += cost.amount;
                        }
                    });
                    
                    const grossMargin = totalSales - totalCosts;
                    const totalVAT = grossMargin > 0 ? grossMargin * this.vatRate / 100 : 0;
                    const netMargin = grossMargin - totalVAT;
                    
                    this.finalResults = {
                        totalSales: totalSales,
                        totalCosts: totalCosts,
                        grossMargin: grossMargin,
                        totalVAT: totalVAT,
                        netMargin: netMargin
                    };
                },
                
                drawChart() {
                    try {
                        const ctx = document.getElementById('marginChart');
                        if (!ctx) return;

                        // Destroy existing chart if any
                        if (this.chart) {
                            this.chart.destroy();
                        }

                    // Modern 3D Gradients for 2025 Trends
                    const salesGradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                    salesGradient.addColorStop(0, 'rgba(16, 185, 129, 1)');    // emerald-500
                    salesGradient.addColorStop(0.5, 'rgba(34, 197, 94, 0.8)'); // emerald-400
                    salesGradient.addColorStop(1, 'rgba(52, 211, 153, 0.2)');  // emerald-300

                    const costsGradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                    costsGradient.addColorStop(0, 'rgba(239, 68, 68, 1)');     // red-500
                    costsGradient.addColorStop(0.5, 'rgba(248, 113, 113, 0.8)'); // red-400
                    costsGradient.addColorStop(1, 'rgba(252, 165, 165, 0.2)'); // red-300

                    const marginGradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                    marginGradient.addColorStop(0, 'rgba(59, 130, 246, 1)');   // blue-500
                    marginGradient.addColorStop(0.5, 'rgba(96, 165, 250, 0.8)'); // blue-400
                    marginGradient.addColorStop(1, 'rgba(147, 197, 253, 0.2)'); // blue-300

                    const vatGradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                    vatGradient.addColorStop(0, 'rgba(147, 51, 234, 1)');      // purple-500
                    vatGradient.addColorStop(0.5, 'rgba(168, 85, 247, 0.8)');  // purple-400
                    vatGradient.addColorStop(1, 'rgba(196, 181, 253, 0.2)');   // purple-300

                    const netGradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                    netGradient.addColorStop(0, 'rgba(6, 182, 212, 1)');       // cyan-500
                    netGradient.addColorStop(0.5, 'rgba(34, 211, 238, 0.8)');  // cyan-400
                    netGradient.addColorStop(1, 'rgba(103, 232, 249, 0.2)');   // cyan-300
                    
                    this.chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['💰 Vendas', '📋 Custos', '📊 Margem Bruta', '🏛️ IVA', '✨ Margem Líquida'],
                            datasets: [{
                                label: 'Valores Financeiros (€)',
                                data: [
                                    this.finalResults.totalSales,
                                    this.finalResults.totalCosts,
                                    this.finalResults.grossMargin,
                                    this.finalResults.totalVAT,
                                    this.finalResults.netMargin
                                ],
                                backgroundColor: [
                                    salesGradient,
                                    costsGradient,
                                    marginGradient,
                                    vatGradient,
                                    netGradient
                                ],
                                borderColor: [
                                    'rgba(16, 185, 129, 1)',   // emerald-500
                                    'rgba(239, 68, 68, 1)',    // red-500
                                    'rgba(59, 130, 246, 1)',   // blue-500
                                    'rgba(147, 51, 234, 1)',   // purple-500
                                    'rgba(6, 182, 212, 1)'     // cyan-500
                                ],
                                borderWidth: 3,
                                borderRadius: {
                                    topLeft: 12,
                                    topRight: 12,
                                    bottomLeft: 4,
                                    bottomRight: 4
                                },
                                borderSkipped: false,
                                shadowOffsetX: 0,
                                shadowOffsetY: 4,
                                shadowBlur: 8,
                                shadowColor: 'rgba(0, 0, 0, 0.15)',
                                hoverBorderWidth: 4,
                                hoverBorderColor: 'rgba(255, 255, 255, 0.8)',
                                hoverBackgroundColor: function(context) {
                                    const gradient = context.chart.ctx.createLinearGradient(0, 0, 0, 400);
                                    gradient.addColorStop(0, 'rgba(255, 255, 255, 0.2)');
                                    gradient.addColorStop(1, 'rgba(0, 0, 0, 0.1)');
                                    return gradient;
                                }
                            }]
                        },
                        plugins: [
                            {
                                id: 'modernDataLabels',
                                afterDatasetsDraw: function(chart) {
                                    const ctx = chart.ctx;
                                    const dataset = chart.data.datasets[0];
                                    const meta = chart.getDatasetMeta(0);

                                    meta.data.forEach((bar, index) => {
                                        const data = dataset.data[index];
                                        const value = Math.abs(data);
                                        const formattedValue = '€' + value.toLocaleString('pt-PT', {
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0
                                        });

                                        // Modern gradient text effect
                                        const gradient = ctx.createLinearGradient(0, bar.y - 30, 0, bar.y - 10);
                                        gradient.addColorStop(0, dataset.borderColor[index]);
                                        gradient.addColorStop(1, 'rgba(255, 255, 255, 0.9)');

                                        // Text shadow effect
                                        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                                        ctx.shadowOffsetX = 1;
                                        ctx.shadowOffsetY = 1;
                                        ctx.shadowBlur = 2;

                                        ctx.fillStyle = gradient;
                                        ctx.font = 'bold 16px "Work Sans", sans-serif';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'bottom';
                                        ctx.fillText(formattedValue, bar.x, bar.y - 12);

                                        // Reset shadow
                                        ctx.shadowColor = 'transparent';

                                        // Add percentage indicator for visual context
                                        const totalSales = Math.abs(dataset.data[0]);
                                        const percentage = ((value / totalSales) * 100).toFixed(1);

                                        ctx.fillStyle = 'rgba(107, 114, 128, 0.8)'; // gray-500
                                        ctx.font = '12px "Poppins", sans-serif';
                                        ctx.fillText(`${percentage}%`, bar.x, bar.y - 35);
                                    });
                                }
                            },
                            {
                                id: 'glassmorphismBackground',
                                beforeDraw: function(chart) {
                                    const ctx = chart.ctx;
                                    const chartArea = chart.chartArea;

                                    // Glassmorphism background effect
                                    const gradient = ctx.createRadialGradient(
                                        chartArea.left + chartArea.width / 2,
                                        chartArea.top + chartArea.height / 2,
                                        0,
                                        chartArea.left + chartArea.width / 2,
                                        chartArea.top + chartArea.height / 2,
                                        Math.max(chartArea.width, chartArea.height) / 2
                                    );
                                    gradient.addColorStop(0, 'rgba(255, 255, 255, 0.1)');
                                    gradient.addColorStop(1, 'rgba(255, 255, 255, 0.02)');

                                    ctx.fillStyle = gradient;
                                    ctx.fillRect(chartArea.left, chartArea.top, chartArea.width, chartArea.height);
                                }
                            }
                        ],
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    top: 50,
                                    bottom: 30,
                                    left: 10,
                                    right: 10
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: true,
                                    backgroundColor: 'rgba(17, 24, 39, 0.95)', // gray-900
                                    titleColor: 'rgba(249, 250, 251, 1)', // gray-50
                                    bodyColor: 'rgba(229, 231, 235, 1)', // gray-200
                                    borderColor: 'rgba(75, 85, 99, 0.5)', // gray-600
                                    borderWidth: 1,
                                    cornerRadius: 12,
                                    padding: 16,
                                    displayColors: true,
                                    titleFont: {
                                        size: 16,
                                        weight: 'bold',
                                        family: '"Work Sans", sans-serif'
                                    },
                                    bodyFont: {
                                        size: 14,
                                        family: '"Poppins", sans-serif'
                                    },
                                    footerFont: {
                                        size: 12,
                                        style: 'italic'
                                    },
                                    animation: {
                                        duration: 300,
                                        easing: 'easeOutCubic'
                                    },
                                    callbacks: {
                                        title: function(tooltipItems) {
                                            return tooltipItems[0].label.replace(/[📊💰📋🏛️✨]/g, '').trim();
                                        },
                                        label: function(context) {
                                            const value = Math.abs(context.parsed.y);
                                            const formattedValue = '€' + value.toLocaleString('pt-PT', {
                                                minimumFractionDigits: 2,
                                                maximumFractionDigits: 2
                                            });

                                            // Calculate percentage
                                            const totalSales = Math.abs(context.chart.data.datasets[0].data[0]);
                                            const percentage = ((value / totalSales) * 100).toFixed(1);

                                            return `${formattedValue} (${percentage}% das vendas)`;
                                        },
                                        footer: function(tooltipItems) {
                                            return 'Conforme CIVA Art. 308º';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grace: '5%',
                                    border: {
                                        display: false
                                    },
                                    grid: {
                                        color: function(context) {
                                            if (context.tick.value === 0) {
                                                return 'rgba(0, 0, 0, 0.1)';
                                            }
                                            return 'rgba(156, 163, 175, 0.1)'; // gray-400
                                        },
                                        lineWidth: function(context) {
                                            if (context.tick.value === 0) {
                                                return 2;
                                            }
                                            return 1;
                                        },
                                        borderDash: [5, 5],
                                        drawBorder: false,
                                        z: 1
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            if (value === 0) return '€0';
                                            return '€' + Math.abs(value).toLocaleString('pt-PT', {
                                                notation: 'compact',
                                                compactDisplay: 'short'
                                            });
                                        },
                                        font: {
                                            size: 13,
                                            family: '"Poppins", sans-serif',
                                            weight: '500'
                                        },
                                        color: 'rgba(75, 85, 99, 0.8)', // gray-600
                                        padding: 12,
                                        maxTicksLimit: 8
                                    }
                                },
                                x: {
                                    border: {
                                        display: false
                                    },
                                    grid: {
                                        display: false,
                                        drawBorder: false
                                    },
                                    ticks: {
                                        font: {
                                            size: 14,
                                            family: '"Work Sans", sans-serif',
                                            weight: '600'
                                        },
                                        color: 'rgba(55, 65, 81, 0.9)', // gray-700
                                        autoSkip: false,
                                        maxRotation: 0,
                                        padding: 8
                                    }
                                }
                            },
                            animation: {
                                duration: 2000,
                                easing: 'easeInOutCubic',
                                delay: function(context) {
                                    return context.dataIndex * 200; // Staggered animation
                                },
                                onComplete: function() {
                                    // GSAP micro-animation on completion
                                    if (typeof gsap !== 'undefined') {
                                        gsap.from('#marginChart', {
                                            scale: 0.98,
                                            duration: 0.3,
                                            ease: 'power2.out'
                                        });
                                    }
                                }
                            },
                            transitions: {
                                resize: {
                                    animation: {
                                        duration: 1000,
                                        easing: 'easeInOutQuart'
                                    }
                                },
                                show: {
                                    animation: {
                                        duration: 1500,
                                        easing: 'easeInOutCubic'
                                    }
                                }
                            }
                        }
                    });
                    
                    // Create pie chart for margin distribution
                    const pieCtx = document.getElementById('marginPieChart');
                    if (pieCtx) {
                        if (this.pieChart) {
                            this.pieChart.destroy();
                        }
                        
                        this.pieChart = new Chart(pieCtx, {
                            type: 'pie',
                            plugins: [{
                                afterDatasetsDraw: function(chart) {
                                    const ctx = chart.ctx;
                                    const dataset = chart.data.datasets[0];
                                    const meta = chart.getDatasetMeta(0);
                                    const total = dataset.data.reduce((a, b) => (a || 0) + (b || 0), 0);
                                    
                                    if (total === 0) return;
                                    
                                    meta.data.forEach((arc, index) => {
                                        const value = dataset.data[index] || 0;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        
                                        // Get the model
                                        const model = arc;
                                        
                                        // Calculate the angle
                                        const midAngle = model.startAngle + (model.endAngle - model.startAngle) / 2;
                                        
                                        // Calculate position - place text at 2/3 of radius
                                        const radius = model.outerRadius * 0.7;
                                        const x = model.x + Math.cos(midAngle) * radius;
                                        const y = model.y + Math.sin(midAngle) * radius;
                                        
                                        // Draw background for better readability
                                        ctx.save();
                                        ctx.globalAlpha = 0.8;
                                        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                                        ctx.beginPath();
                                        ctx.arc(x, y, 25, 0, 2 * Math.PI);
                                        ctx.fill();
                                        ctx.restore();
                                        
                                        // Draw percentage
                                        ctx.fillStyle = '#ffffff';
                                        ctx.font = 'bold 14px Arial';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.fillText(percentage + '%', x, y);
                                    });
                                }
                            }],
                            data: {
                                labels: ['Margem Líquida', 'IVA', 'Custos'],
                                datasets: [{
                                    data: [
                                        this.finalResults.netMargin,
                                        this.finalResults.totalVAT,
                                        this.finalResults.totalCosts
                                    ],
                                    backgroundColor: [
                                        'rgba(59, 130, 246, 0.8)',
                                        'rgba(147, 51, 234, 0.8)',
                                        'rgba(239, 68, 68, 0.8)'
                                    ],
                                    borderColor: [
                                        'rgba(59, 130, 246, 1)',
                                        'rgba(147, 51, 234, 1)',
                                        'rgba(239, 68, 68, 1)'
                                    ],
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                layout: {
                                    padding: {
                                        top: 20,
                                        bottom: 40,
                                        left: 20,
                                        right: 20
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false  // Using custom legend instead
                                    },
                                    datalabels: {
                                        display: true,
                                        color: 'white',
                                        font: {
                                            weight: 'bold',
                                            size: 16
                                        },
                                        formatter: (value, ctx) => {
                                            const sum = ctx.dataset.data.reduce((a, b) => (a || 0) + (b || 0), 0);
                                            const percentage = sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0%';
                                            return percentage;
                                        }
                                    },
                                    title: {
                                        display: false  // Title is now in the HTML
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const value = context.parsed;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return context.label + ': €' + value.toLocaleString('pt-PT', {
                                                    minimumFractionDigits: 2
                                                }) + ' (' + percentage + '%)';
                                            }
                                        }
                                    }
                                },
                                animation: {
                                    animateRotate: true,
                                    animateScale: true
                                }
                            }
                        });
                    }
                    
                    // Create comparison chart (Normal VAT vs Margin VAT)
                    const comparisonCtx = document.getElementById('comparisonChart');
                    if (comparisonCtx) {
                        if (this.comparisonChart) {
                            this.comparisonChart.destroy();
                        }
                        
                        const normalVat = this.finalResults.totalSales * this.vatRate / 100;
                        const marginVat = this.finalResults.totalVAT;
                        const savings = normalVat - marginVat;
                        const savingsPercentage = normalVat > 0 ? (savings / normalVat * 100) : 0;
                        
                        this.comparisonChart = new Chart(comparisonCtx, {
                            type: 'bar',
                            plugins: [{
                                afterDatasetsDraw: function(chart) {
                                    const ctx = chart.ctx;
                                    chart.data.datasets.forEach((dataset, i) => {
                                        const meta = chart.getDatasetMeta(i);
                                        meta.data.forEach((bar, index) => {
                                            const data = dataset.data[index];
                                            const formattedValue = '€' + data.toLocaleString('pt-PT', {
                                                minimumFractionDigits: 2,
                                                maximumFractionDigits: 2
                                            });
                                            
                                            ctx.fillStyle = dataset.borderColor[index];
                                            ctx.font = 'bold 14px Arial';
                                            ctx.textAlign = 'left';
                                            ctx.textBaseline = 'middle';
                                            ctx.fillText(formattedValue, bar.x + bar.width + 10, bar.y);
                                        });
                                    });
                                }
                            }],
                            data: {
                                labels: ['IVA Regime Normal', 'IVA sobre Margem'],
                                datasets: [{
                                    label: 'Valor do IVA (€)',
                                    data: [normalVat, marginVat],
                                    backgroundColor: [
                                        'rgba(239, 68, 68, 0.8)',
                                        'rgba(34, 197, 94, 0.8)'
                                    ],
                                    borderColor: [
                                        'rgba(239, 68, 68, 1)',
                                        'rgba(34, 197, 94, 1)'
                                    ],
                                    borderWidth: 2,
                                    borderRadius: 8
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: `Poupança Fiscal: €${savings.toFixed(2)} (${savingsPercentage.toFixed(1)}%)`,
                                        font: {
                                            size: 16,
                                            weight: 'bold'
                                        },
                                        padding: 20,
                                        color: 'rgba(34, 197, 94, 1)'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.dataset.label + ': €' + 
                                                    context.parsed.x.toLocaleString('pt-PT', {
                                                        minimumFractionDigits: 2,
                                                        maximumFractionDigits: 2
                                                    });
                                            },
                                            afterLabel: function(context) {
                                                if (context.dataIndex === 0) {
                                                    return `Taxa: ${this.vatRate || 23}% sobre vendas totais`;
                                                } else {
                                                    return `Taxa: ${this.vatRate || 23}% sobre margem`;
                                                }
                                            }.bind(this)
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return '€' + value.toLocaleString('pt-PT');
                                            }
                                        },
                                        grid: {
                                            borderDash: [2, 2]
                                        }
                                    },
                                    y: {
                                        grid: {
                                            display: false
                                        }
                                    }
                                },
                                animation: {
                                    duration: 1500,
                                    easing: 'easeInOutQuart'
                                }
                            }
                        });
                    }
                    
                    // Advanced charts removed - aligned with PDF output
                    } catch (error) {
                        console.error('Error drawing charts:', error);
                        // Don't let chart errors break the page
                    }
                },
                
                // Helper function to get calculation results
                getCalculationResults() {
                    // Create calculation results from sales and costs data
                    const results = [];
                    
                    this.sales.forEach(sale => {
                        const linkedCosts = this.costs.filter(c => 
                            c.linked_sales && c.linked_sales.includes(sale.id)
                        );
                        
                        const totalCosts = linkedCosts.reduce((sum, cost) => {
                            // Proportional cost allocation
                            const costShareCount = cost.linked_sales ? cost.linked_sales.length : 1;
                            return sum + (cost.amount / costShareCount);
                        }, 0);
                        
                        results.push({
                            invoice_number: sale.number,
                            date: sale.date,
                            client: sale.client,
                            sale_amount: sale.amount,
                            total_allocated_costs: totalCosts,
                            gross_margin: sale.amount - totalCosts,
                            vat_amount: (sale.amount - totalCosts) > 0 ? 
                                (sale.amount - totalCosts) * this.vatRate / 100 : 0
                        });
                    });
                    
                    return results;
                },
                
                
                // Utility Methods
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('pt-PT');
                },
                
                getCostName(costId) {
                    const cost = this.costs.find(c => c.id === costId);
                    return cost ? cost.supplier.split(' ')[0] : costId;
                },
                
                getSaleName(saleId) {
                    const sale = this.sales.find(s => s.id === saleId);
                    return sale ? sale.number.split('/')[0] : saleId;
                },
                
                saveSession() {
                    localStorage.setItem('ivaSession', JSON.stringify({
                        sessionId: this.sessionId,
                        sales: this.sales,
                        costs: this.costs
                    }));
                },
                
                async reloadSession() {
                    if (!this.sessionId) return;
                    
                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/session/${this.sessionId}`, {}, 10000);
                        const data = await response.json();
                        
                        this.sales = data.sales;
                        this.costs = data.costs;
                        
                        this.saveSession();
                    } catch (error) {
                        console.error('Error reloading session:', error);
                    }
                },
                
                startNew() {
                    // Clear everything and start over
                    this.sessionId = null;
                    this.sales = [];
                    this.costs = [];
                    this.selectedSales = [];
                    this.selectedCosts = [];
                    this.finalResults = {};
                    this.currentStep = 1;
                    
                    localStorage.removeItem('ivaSession');
                    
                    this.showNotification('Nova Sessão', 'Pronto para nova análise', 'info');
                },
                
                resetSession() {
                    if (confirm('Tem certeza que deseja resetar todos os dados?')) {
                        this.startNew();
                    }
                },
                
                // Notifications
                showNotification(title, message, type = 'info') {
                    const notification = {
                        title,
                        message,
                        type,
                        show: true
                    };
                    
                    this.notifications.push(notification);
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        const index = this.notifications.indexOf(notification);
                        if (index > -1) {
                            this.notifications[index].show = false;
                            setTimeout(() => {
                                this.notifications.splice(index, 1);
                            }, 300);
                        }
                    }, 5000);
                },
                
                removeNotification(index) {
                    this.notifications[index].show = false;
                    setTimeout(() => {
                        this.notifications.splice(index, 1);
                    }, 300);
                },
                
                // Download Excel function
                async downloadExcel() {
                    if (!this.sessionId || !this.finalResults.totalSales) {
                        this.showNotification('Aviso', 'Por favor calcule primeiro os resultados', 'warning');
                        return;
                    }
                    
                    this.loading = true;
                    this.loadingMessage = 'A gerar ficheiro Excel...';

                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/calculate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                vat_rate: this.vatRate
                            })
                        }, 25000);
                        
                        if (!response.ok) {
                            throw new Error('Erro ao gerar Excel');
                        }
                        
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `iva_margem_${new Date().toISOString().split('T')[0]}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        this.showNotification('Sucesso!', 'Ficheiro Excel descarregado', 'success');
                        
                    } catch (error) {
                        console.error('Download error:', error);
                        this.showNotification('Erro', 'Erro ao descarregar Excel', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // Start new analysis
                startNew() {
                    if (confirm('Tem a certeza que deseja iniciar uma nova análise? Os dados atuais serão perdidos.')) {
                        // Reset all data
                        this.currentStep = 1;
                        this.sessionId = null;
                        this.sales = [];
                        this.costs = [];
                        this.selectedSales = [];
                        this.selectedCosts = [];
                        this.finalResults = {};
                        this.efaturaFiles = {
                            vendas: null,
                            compras: null
                        };
                        
                        // Clear session storage
                        localStorage.removeItem('ivaSession');
                        
                        this.showNotification('Nova Análise', 'Pronto para iniciar nova análise', 'info');
                    }
                },
                
                // Download PDF function (binary)
                async downloadPDF() {
                    if (!this.sessionId || !this.finalResults.totalSales) {
                        this.showNotification('Aviso', 'Por favor calcule primeiro os resultados', 'warning');
                        return;
                    }
                    
                    this.loading = true;
                    this.loadingMessage = 'A gerar relatório PDF...';
                    
                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/export-pdf`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                vat_rate: this.vatRate,
                                results: this.finalResults,
                                format: 'pdf'
                            })
                        }, 30000);
                        
                        if (!response.ok) {
                            throw new Error('Erro ao gerar PDF');
                        }
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Relatorio_IVA_Margem_${this.sessionId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                        this.showNotification('Sucesso!', 'Relatório PDF descarregado com sucesso', 'success');
                        
                    } catch (error) {
                        console.error('PDF generation error:', error);
                        this.showNotification('Erro', 'Erro ao gerar relatório PDF', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                // Preview PDF (HTML)
                async previewPDF() {
                    if (!this.sessionId || !this.finalResults.totalSales) {
                        this.showNotification('Aviso', 'Por favor calcule primeiro os resultados', 'warning');
                        return;
                    }
                    this.loading = true;
                    this.loadingMessage = 'A gerar pré-visualização do relatório...';
                    try {
                        const response = await this.apiFetch(`${this.apiUrl}/api/export-pdf`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: this.sessionId,
                                vat_rate: this.vatRate,
                                results: this.finalResults,
                                format: 'html'
                            })
                        }, 30000);
                        if (!response.ok) throw new Error('Erro na pré-visualização');
                        const html = await response.text();
                        const w = window.open('', '_blank');
                        w.document.write(html);
                        w.document.close();
                        this.showNotification('Sucesso!', 'Pré-visualização aberta numa nova aba', 'success');
                    } catch (error) {
                        console.error('Preview error:', error);
                        this.showNotification('Erro', error.message || 'Erro ao gerar pré-visualização', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // Get icon for supplier type
                getSupplierIcon(supplier) {
                    const supplierLower = supplier.toLowerCase();
                    
                    // Hotels and accommodation
                    if (supplierLower.includes('hotel') || supplierLower.includes('pestana') || 
                        supplierLower.includes('marriott') || supplierLower.includes('hilton') ||
                        supplierLower.includes('radisson') || supplierLower.includes('ibis') ||
                        supplierLower.includes('solar') || supplierLower.includes('hospedagem')) {
                        return 'fas fa-bed';
                    }
                    
                    // Airlines and aviation
                    if (supplierLower.includes('tap') || supplierLower.includes('ryanair') || 
                        supplierLower.includes('easyjet') || supplierLower.includes('lufthansa') ||
                        supplierLower.includes('air') || supplierLower.includes('fly') ||
                        supplierLower.includes('aviacao') || supplierLower.includes('aviação') ||
                        supplierLower.includes('passagem')) {
                        return 'fas fa-plane';
                    }
                    
                    // Transportation (taxis, transfers)
                    if (supplierLower.includes('taxi') || supplierLower.includes('transfer') || 
                        supplierLower.includes('ludovino') || supplierLower.includes('auto taxi')) {
                        return 'fas fa-taxi';
                    }
                    
                    // Car rental
                    if (supplierLower.includes('rent') || supplierLower.includes('aluguer') || 
                        supplierLower.includes('hertz') || supplierLower.includes('avis') ||
                        supplierLower.includes('europcar')) {
                        return 'fas fa-car';
                    }
                    
                    // Trains
                    if (supplierLower.includes('cp ') || supplierLower.includes('comboios') || 
                        supplierLower.includes('train') || supplierLower.includes('rail')) {
                        return 'fas fa-train';
                    }
                    
                    // Food and restaurants
                    if (supplierLower.includes('restaurante') || supplierLower.includes('restaurant') || 
                        supplierLower.includes('cafe') || supplierLower.includes('café') ||
                        supplierLower.includes('confeitaria') || supplierLower.includes('pastelaria') ||
                        supplierLower.includes('nata') || supplierLower.includes('ginginha') ||
                        supplierLower.includes('salsicharia') || supplierLower.includes('food')) {
                        return 'fas fa-utensils';
                    }
                    
                    // Stores and shopping
                    if (supplierLower.includes('store') || supplierLower.includes('loja') || 
                        supplierLower.includes('shop') || supplierLower.includes('mart') ||
                        supplierLower.includes('produtos') || supplierLower.includes('gms')) {
                        return 'fas fa-shopping-bag';
                    }
                    
                    // Tickets and events
                    if (supplierLower.includes('ticket') || supplierLower.includes('bilhet') || 
                        supplierLower.includes('blueticket')) {
                        return 'fas fa-ticket-alt';
                    }
                    
                    // Tourism activities
                    if (supplierLower.includes('tour') || supplierLower.includes('excurs') || 
                        supplierLower.includes('museu') || supplierLower.includes('museum') ||
                        supplierLower.includes('ideias')) {
                        return 'fas fa-map-marked-alt';
                    }
                    
                    // Cruises
                    if (supplierLower.includes('cruise') || supplierLower.includes('cruzeiro') || 
                        supplierLower.includes('navio')) {
                        return 'fas fa-ship';
                    }
                    
                    // Bus
                    if (supplierLower.includes('bus') || supplierLower.includes('autocarro')) {
                        return 'fas fa-bus';
                    }
                    
                    // Insurance
                    if (supplierLower.includes('seguro') || supplierLower.includes('insurance')) {
                        return 'fas fa-shield-alt';
                    }
                    
                    // Travel agencies
                    if (supplierLower.includes('viagens') || supplierLower.includes('travel') || 
                        supplierLower.includes('turismo')) {
                        return 'fas fa-globe-europe';
                    }
                    
                    // Default for services
                    return 'fas fa-receipt';
                },
                
                // Get icon color based on supplier type
                getSupplierIconColor(supplier) {
                    const icon = this.getSupplierIcon(supplier);
                    
                    switch(icon) {
                        case 'fas fa-bed': return 'text-blue-600';
                        case 'fas fa-plane': return 'text-sky-600';
                        case 'fas fa-taxi': return 'text-yellow-600';
                        case 'fas fa-car': return 'text-gray-600';
                        case 'fas fa-train': return 'text-green-600';
                        case 'fas fa-utensils': return 'text-orange-600';
                        case 'fas fa-shopping-bag': return 'text-pink-600';
                        case 'fas fa-ticket-alt': return 'text-purple-600';
                        case 'fas fa-map-marked-alt': return 'text-purple-600';
                        case 'fas fa-ship': return 'text-cyan-600';
                        case 'fas fa-bus': return 'text-yellow-600';
                        case 'fas fa-shield-alt': return 'text-indigo-600';
                        case 'fas fa-globe-europe': return 'text-teal-600';
                        case 'fas fa-receipt': return 'text-gray-500';
                        default: return 'text-gray-500';
                    }
                },

                // Get icon for sale/customer type
                getSaleIcon(sale) {
                    const n = (sale.number || '').toLowerCase();
                    const c = (sale.client || '').toLowerCase();
                    // Credit notes
                    if (n.startsWith('nc') || c.includes('cancel')) return 'fas fa-undo-alt';
                    // Invoice/receipt vs simplified
                    if (n.startsWith('fr')) return 'fas fa-receipt';
                    if (n.startsWith('fs') || n.includes('simplificada')) return 'fas fa-file-invoice';
                    // International/flight keywords
                    if (c.includes('international') || c.includes('premium') || c.includes('flight') || c.includes('voo')) return 'fas fa-plane-departure';
                    // Cruise / package
                    if (c.includes('cruzeiro') || c.includes('cruise')) return 'fas fa-ship';
                    // City break / hotel
                    if (c.includes('hotel') || c.includes('alojamento')) return 'fas fa-bed';
                    // Default
                    return 'fas fa-suitcase-rolling';
                },
                getSaleIconColor(sale) {
                    const ic = this.getSaleIcon(sale);
                    switch(ic){
                        case 'fas fa-undo-alt': return 'text-rose-600';
                        case 'fas fa-receipt': return 'text-emerald-600';
                        case 'fas fa-file-invoice': return 'text-indigo-600';
                        case 'fas fa-plane-departure': return 'text-sky-600';
                        case 'fas fa-ship': return 'text-cyan-600';
                        case 'fas fa-bed': return 'text-blue-600';
                        default: return 'text-slate-600';
                    }
                },

                // Debug Functions
                async testApiConnection() {
                    this.loading = true;
                    this.loadingMessage = 'A testar conexão API...';

                    try {
                        console.log('[Debug] Testing API connection...');
                        const response = await this.apiFetch(`${this.apiUrl}/`, {
                            method: 'GET'
                        }, 5000); // 5 second timeout

                        if (response.ok) {
                            const data = await response.text();
                            console.log('[Debug] API Response:', data.substring(0, 100));
                            this.showNotification('API Test', 'Conexão OK! Backend está a funcionar', 'success');
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }

                    } catch (error) {
                        console.error('[Debug] API Test failed:', error);
                        this.showNotification('API Test', `Erro: ${error.message}`, 'error');
                    } finally {
                        this.loading = false;
                        this.loadingMessage = '';
                    }
                },

                clearSession() {
                    if (confirm('Limpar todos os dados da sessão?')) {
                        this.sessionId = null;
                        this.sales = [];
                        this.costs = [];
                        this.selectedSales = [];
                        this.selectedCosts = [];
                        this.finalResults = {};
                        this.currentStep = 1;
                        this.efaturaFiles = { vendas: null, compras: null };

                        localStorage.removeItem('ivaSession');

                        console.log('[Debug] Session cleared');
                        this.showNotification('Debug', 'Sessão limpa', 'info');
                    }
                }
            }
        }
    </script>
    
    <!-- Alpine.js - Load after app definition -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Modern Animation Initialization -->
    <script>
        // Wait for Alpine.js and GSAP to be ready
        document.addEventListener('alpine:init', () => {
            // Modern micro-animations initialization
            initializeModernAnimations();
        });

        function initializeModernAnimations() {
            // Only run if GSAP is available
            if (typeof gsap === 'undefined') return;

            // Set up intersection observer for scroll animations
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const animateOnScroll = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;

                        // Animate modern corporate cards with elegant entrance
                        if (element.classList.contains('modern-card')) {
                            gsap.fromTo(element,
                                {
                                    y: 30,
                                    opacity: 0,
                                    scale: 0.95
                                },
                                {
                                    y: 0,
                                    opacity: 1,
                                    scale: 1,
                                    duration: 0.6,
                                    ease: 'power2.out',
                                    delay: Array.from(element.parentNode.children).indexOf(element) * 0.1
                                }
                            );
                        }

                        // Animate chart containers with smooth entrance
                        if (element.classList.contains('chart-container')) {
                            gsap.fromTo(element,
                                {
                                    opacity: 0,
                                    y: 30,
                                    rotationX: -15
                                },
                                {
                                    opacity: 1,
                                    y: 0,
                                    rotationX: 0,
                                    duration: 1,
                                    ease: 'power2.out'
                                }
                            );
                        }

                        // Animate chart containers
                        if (element.classList.contains('chart-container')) {
                            gsap.fromTo(element,
                                {
                                    opacity: 0,
                                    scale: 0.8,
                                    y: 40
                                },
                                {
                                    opacity: 1,
                                    scale: 1,
                                    y: 0,
                                    duration: 1.2,
                                    ease: 'power3.out'
                                }
                            );
                        }

                        // Unobserve after animation
                        animateOnScroll.unobserve(element);
                    }
                });
            }, observerOptions);

            // Observe elements for animation
            setTimeout(() => {
                document.querySelectorAll('.modern-card, .chart-container, .data-point').forEach(el => {
                    animateOnScroll.observe(el);
                });
            }, 100);

            // Add hover micro-animations
            document.querySelectorAll('.interactive-element').forEach(element => {
                element.addEventListener('mouseenter', () => {
                    gsap.to(element, {
                        scale: 1.02,
                        y: -2,
                        duration: 0.3,
                        ease: 'power2.out'
                    });
                });

                element.addEventListener('mouseleave', () => {
                    gsap.to(element, {
                        scale: 1,
                        y: 0,
                        duration: 0.3,
                        ease: 'power2.out'
                    });
                });
            });

            // Animate progress bars with smooth fill
            document.querySelectorAll('.h-1.bg-gradient-to-r').forEach(bar => {
                gsap.fromTo(bar,
                    { scaleX: 0, transformOrigin: 'left' },
                    {
                        scaleX: 1,
                        duration: 1.5,
                        ease: 'power2.out',
                        delay: 0.5
                    }
                );
            });

            // Add floating animation to floating elements
            document.querySelectorAll('.float-animation').forEach(element => {
                gsap.to(element, {
                    y: -8,
                    duration: 3,
                    ease: 'power1.inOut',
                    yoyo: true,
                    repeat: -1
                });
            });

            // Pulse animation for special elements
            document.querySelectorAll('.pulse-subtle').forEach(element => {
                gsap.to(element, {
                    scale: 1.1,
                    duration: 2,
                    ease: 'power1.inOut',
                    yoyo: true,
                    repeat: -1
                });
            });

            // Success animations
            document.querySelectorAll('.success-ping').forEach(element => {
                gsap.to(element, {
                    scale: 1.2,
                    opacity: 0.7,
                    duration: 1,
                    ease: 'power2.out',
                    yoyo: true,
                    repeat: -1,
                    repeatDelay: 2
                });
            });
        }

        // Re-initialize animations when content changes
        document.addEventListener('DOMContentLoaded', () => {
            // MutationObserver to watch for new elements
            const observer = new MutationObserver(() => {
                // Re-run animations for newly added elements
                setTimeout(initializeModernAnimations, 100);
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>

    <!-- Footer Accounting Advantage -->
    <footer class="bg-gray-900 text-gray-300 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Company Info -->
                <div>
                    <h3 class="text-white text-lg font-semibold mb-4">Accounting Advantage</h3>
                    <p class="text-sm mb-4 italic">"Fazer um bom trabalho é Amar o que se faz"</p>
                    <p class="text-sm">Sistema profissional de cálculo de IVA sobre margem para agências de viagens, desenvolvido com dedicação e expertise fiscal.</p>
                </div>
                
                <!-- Contact Info -->
                <div>
                    <h4 class="text-white text-lg font-semibold mb-4">Contactos</h4>
                    <div class="space-y-2 text-sm">
                        <p class="flex items-center">
                            <i class="fas fa-envelope mr-2 text-blue-400"></i>
                            <a href="mailto:geral@accountingadvantage.pt" class="hover:text-white transition-colors">
                                geral@accountingadvantage.pt
                            </a>
                        </p>
                        <p class="flex items-center">
                            <i class="fas fa-phone mr-2 text-blue-400"></i>
                            <span>+351 219 586 265 / +351 910 542 488</span>
                        </p>
                        <p class="flex items-start">
                            <i class="fas fa-map-marker-alt mr-2 text-blue-400 mt-1"></i>
                            <span>Rua Almada Negreiros Lote 5-lj 14<br>2615-275 Alverca Ribatejo</span>
                        </p>
                    </div>
                </div>
                
                <!-- Social & Credits -->
                <div>
                    <h4 class="text-white text-lg font-semibold mb-4">Siga-nos</h4>
                    <div class="flex space-x-4 mb-6">
                        <a href="https://www.facebook.com/AccountingAdvantage.pt" 
                           target="_blank"
                           class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-blue-600 transition-colors">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="https://www.linkedin.com/in/cláudia-patricia-azevedo/" 
                           target="_blank"
                           class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-blue-600 transition-colors">
                            <i class="fab fa-linkedin-in"></i>
                        </a>
                        <a href="https://www.advantage.pt" 
                           target="_blank"
                           class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center hover:bg-blue-600 transition-colors">
                            <i class="fas fa-globe"></i>
                        </a>
                    </div>
                    <p class="text-sm">
                        Desenvolvido com <i class="fas fa-heart text-red-500"></i> por<br>
                        <strong class="text-white">Accounting Advantage</strong>
                    </p>
                </div>
            </div>
            
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-sm">
                <p>© 2025 Accounting Advantage. Todos os direitos reservados.</p>
                <p class="mt-2 text-xs text-gray-500">
                    IVA Margem Turismo v2.0 | Regime especial CIVA Art. 308º
                </p>
            </div>
        </div>
    </footer>

</body>
</html>
