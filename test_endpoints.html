<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <title>Teste de Endpoints</title>
</head>
<body>
    <h1>Teste de Endpoints IVA Margem</h1>
    
    <button onclick="testMockData()">1. Carregar Dados Mock</button>
    <button onclick="testAssociate()" id="btnAssociate" disabled>2. Testar Associate</button>
    <button onclick="testCalculate()" id="btnCalculate" disabled>3. Testar Calculate</button>
    
    <pre id="results"></pre>
    
    <script>
        let sessionId = null;
        let sales = [];
        let costs = [];
        const apiUrl = 'http://localhost:8000';
        
        function log(message) {
            document.getElementById('results').textContent += message + '\n';
        }
        
        async function testMockData() {
            try {
                log('Testando GET /api/mock-data...');
                const response = await fetch(`${apiUrl}/api/mock-data`);
                const data = await response.json();
                
                if (response.ok) {
                    sessionId = data.session_id;
                    sales = data.sales;
                    costs = data.costs;
                    log(`✓ Mock data carregado: session_id=${sessionId}, ${sales.length} vendas, ${costs.length} custos`);
                    document.getElementById('btnAssociate').disabled = false;
                } else {
                    log(`✗ Erro: ${response.status} - ${JSON.stringify(data)}`);
                }
            } catch (error) {
                log(`✗ Erro: ${error.message}`);
            }
        }
        
        async function testAssociate() {
            if (!sessionId) {
                log('✗ Erro: Sem session_id');
                return;
            }
            
            try {
                log('Testando POST /api/associate...');
                const response = await fetch(`${apiUrl}/api/associate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        sale_ids: [sales[0]?.id || 's1'],
                        cost_ids: [costs[0]?.id || 'c1']
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(`✓ Associate funcionando: ${data.message}`);
                    document.getElementById('btnCalculate').disabled = false;
                } else {
                    log(`✗ Erro: ${response.status} - ${JSON.stringify(data)}`);
                }
            } catch (error) {
                log(`✗ Erro: ${error.message}`);
            }
        }
        
        async function testCalculate() {
            if (!sessionId) {
                log('✗ Erro: Sem session_id');
                return;
            }
            
            try {
                log('Testando POST /api/calculate...');
                const response = await fetch(`${apiUrl}/api/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        vat_rate: 23
                    })
                });
                
                if (response.ok) {
                    log('✓ Calculate funcionando: Excel gerado');
                    const blob = await response.blob();
                    log(`  Tamanho do arquivo: ${blob.size} bytes`);
                } else {
                    const text = await response.text();
                    log(`✗ Erro: ${response.status} - ${text}`);
                }
            } catch (error) {
                log(`✗ Erro: ${error.message}`);
            }
        }
    </script>
</body>
</html>